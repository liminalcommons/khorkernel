# Khora Kernel Plugin Development Guide

## Overview

This guide provides comprehensive documentation for developing plugins (extensions) for the Khora Kernel using the Plugin SDK. The SDK provides a structured framework for creating extensions that can hook into the PyScaffold action system and provide consistent functionality.

## Plugin Architecture

### Core Concepts

Khora plugins are built on top of PyScaffold's extension system, with the following key enhancements:

1. **Type Safety**: The SDK provides strong typing and interfaces for all components
2. **Standardized Error Handling**: Common error handling patterns for resilient extensions
3. **Structured Configuration Access**: Safe, type-aware access to manifest configuration
4. **Context Contribution**: Standardized mechanism for contributing to context.yaml
5. **Template Management**: Utilities for loading and rendering templates

### Plugin Lifecycle

The lifecycle of a Khora plugin follows these stages:

1. **Registration**: The plugin is registered with PyScaffold via entry points in `pyproject.toml`
2. **Discovery**: Khora discovers the plugin via the entry point system
3. **CLI Augmentation**: The plugin adds its command-line options to the parser
4. **Activation**: When enabled, the plugin registers its actions with the action pipeline
5. **Action Execution**: The plugin's actions run in the order defined by their hooks
6. **Context Contribution**: The plugin contributes to the project's context.yaml

### Action Pipeline

The action pipeline is the core of PyScaffold's extension system. Actions are executed in a specific order, transforming the project structure and options along the way:

1. The pipeline starts with a basic set of actions from PyScaffold core
2. Extensions can add their own actions at specific points in the pipeline
3. Actions transform the structure (a dict of files and their contents) and options (project configuration)
4. The final structure is written to disk to create the project

### Hook Points

Extensions can hook into the action pipeline at specific points:

- Before any existing action (using `before=action_name`)
- After any existing action (using `after=action_name`)
- At the end of the pipeline (default)

Common hook points include:

| Hook Point | Description |
|------------|-------------|
| `define_structure` | After the basic project structure is defined |
| `verify_project_dir` | After the project directory is verified |
| `create_structure` | Before the structure is written to disk |
| `init_git` | Before Git is initialized |
| `report_done` | Before the final success message |

## Developing a Plugin

### Step 1: Create Your Extension Class

Create a new class that inherits from `KhoraExtension`:

```python
from khora_kernel_vnext.sdk import KhoraExtension

class MyPlugin(KhoraExtension):
    """
    My awesome Khora plugin.
    
    This plugin adds cool functionality to Khora projects.
    """
    
    name = "my_plugin"  # Will be available as --my-plugin in CLI
    
    def activate(self, actions):
        """Activate the plugin by registering actions."""
        # Only proceed if the plugin is enabled
        if not self.opts.get(self.name):
            return actions
            
        # Register your actions
        actions = self.register(
            actions, 
            my_action_function, 
            after="define_structure"
        )
        
        return actions
        
    def requires(self):
        """Define plugin dependencies."""
        # Depend on the core extension
        return ["khora_core"]
```

### Step 2: Define Your Actions

Actions are functions that modify the PyScaffold structure and options:

```python
from khora_kernel_vnext.sdk import create_extension_action
from pyscaffold.operations import no_overwrite

def my_action_function(struct, opts):
    """Add my plugin's files to the project structure."""
    # Create your structure modifications
    new_files = {
        "my_plugin/my_file.py": (
            "# Generated by MyPlugin\n\ndef hello():\n    print('Hello')\n",
            no_overwrite(),
        )
    }
    
    # Merge with existing structure
    struct.update(new_files)
    
    return struct, opts

# Alternatively, use the factory function for better error handling
my_named_action = create_extension_action(
    "generate_my_files",
    my_action_function,
    "Generates files for MyPlugin"
)
```

### Step 3: Access Configuration

The SDK provides structured access to the Khora manifest configuration:

```python
from khora_kernel_vnext.sdk import get_config_accessor

def config_aware_action(struct, opts):
    """Create files based on configuration."""
    config = get_config_accessor(opts)
    
    # Check if a feature is enabled
    if config.is_feature_enabled("my_feature"):
        # Add feature-specific files
        struct["my_feature_file.py"] = ("# Feature-specific content", no_overwrite())
        
    # Get a path with default
    api_dir = config.get_path("api_dir", "api")
    
    # Get plugin-specific configuration
    my_plugin_config = config.get_plugin_config("my_plugin")
    if my_plugin_config:
        # Use plugin configuration
        pass
        
    return struct, opts
```

### Step 4: Work with Templates

The SDK provides utilities for loading and rendering templates:

```python
from khora_kernel_vnext.sdk import TemplateManager

def template_action(struct, opts):
    """Generate files from templates."""
    # Create a template manager for your plugin
    template_mgr = TemplateManager("my_plugin")
    
    # Load a template
    template_content = template_mgr.get_template("my_template")
    
    # Render with context (PyScaffold style)
    context = {"project_name": opts.get("project_path").name}
    rendered_content = template_mgr.render_pyscaffold_template(
        template_content,
        context
    )
    
    # Or use Jinja2 for more complex templates
    jinja_template = template_mgr.get_template("complex_template")
    jinja_rendered = template_mgr.render_jinja2_template(
        jinja_template,
        context
    )
    
    # Add to structure
    struct["my_file.py"] = (rendered_content, no_overwrite())
    struct["complex_file.py"] = (jinja_rendered, no_overwrite())
    
    return struct, opts
```

### Step 5: Contribute to Context

Extensions can contribute structured information to the context.yaml file:

```python
from khora_kernel_vnext.sdk import ContributedComponent, add_component_to_opts

def contribute_context(struct, opts):
    """Contribute to context.yaml."""
    # Create a component
    component = ContributedComponent(
        name="my_component",
        component_type="service",
        metadata={
            "language": "python",
            "endpoints": ["GET /api/v1/resource"],
            "dependencies": ["another_component"]
        }
    )
    
    # Add to opts for later context.yaml generation
    add_component_to_opts(opts, "my_component", component.to_dict())
    
    return struct, opts
```

### Step 6: Register Your Plugin

Register your plugin in your project's `pyproject.toml`:

```toml
[project.entry-points."pyscaffold.cli"]
my_plugin = "my_package.my_module:MyPlugin"
```

## Advanced Topics

### Error Handling

The SDK provides standardized error handling patterns:

```python
import logging
logger = logging.getLogger(__name__)

def robust_action(struct, opts):
    """An action with robust error handling."""
    try:
        # Your code
        return struct, opts
    except FileNotFoundError as e:
        logger.error(f"Required file not found: {e}")
        # Return unchanged structure and opts
        return struct, opts
    except Exception as e:
        logger.error(f"Unexpected error in MyPlugin: {e}")
        # Return unchanged structure and opts
        return struct, opts
```

The `create_extension_action` factory wraps your action with standardized error handling:

```python
from khora_kernel_vnext.sdk import create_extension_action

my_robust_action = create_extension_action(
    "my_action",
    my_action_function,
    "Does something important"
)
```

### Working with File System

The SDK provides utilities for working with the file system:

```python
from khora_kernel_vnext.sdk import ensure_directory, copy_directory_structure

def fs_action(struct, opts):
    """An action that works with the file system."""
    # Ensure a directory exists
    project_dir = opts.get("project_path")
    ensure_directory(project_dir / "my_dir")
    
    # Copy a directory structure
    template_dir = Path(__file__).parent / "templates"
    copy_directory_structure(template_dir, project_dir / "copied_templates")
    
    return struct, opts
```

### Running External Commands

The SDK provides a utility for safely running shell commands:

```python
from khora_kernel_vnext.sdk import safe_run_command

def command_action(struct, opts):
    """An action that runs shell commands."""
    project_dir = opts.get("project_path")
    
    # Run a command safely
    result = safe_run_command(
        ["npm", "init", "-y"],
        cwd=project_dir,
        check=True
    )
    
    if result.returncode == 0:
        logger.info("npm init successful")
    
    return struct, opts
```

### Plugin Dependencies

Extensions can specify dependencies on other extensions:

```python
class DependentPlugin(KhoraExtension):
    """A plugin that depends on other plugins."""
    
    name = "dependent_plugin"
    
    def requires(self):
        """Define plugin dependencies."""
        # This plugin requires both core and docker
        return ["khora_core", "khora_docker"]
```

## Component Reference

### Key Interfaces and Classes

#### `KhoraExtension`

Base class for all Khora extensions. Inherits from PyScaffold's Extension and adds:

- `register()`: Enhanced action registration with better error handling
- `requires()`: Method to specify dependencies on other extensions
- `validate_config()`: Method to validate configuration
- `create_merged_structure()`: Safely merge two structures

```python
class MyExtension(KhoraExtension):
    name = "my_extension"
    
    def activate(self, actions):
        # Implementation
        pass
```

#### `KhoraComponentProvider`

Protocol for extensions that provide component information to context.yaml:

```python
class MyComponentProvider(KhoraComponentProvider):
    def get_component_info(self, opts):
        # Return component information
        return {
            "name": "my_component",
            "type": "service",
            # ...
        }
```

#### `ContextContributor`

Protocol for extensions that contribute to context.yaml:

```python
class MyContextContributor(ContextContributor):
    def contribute_to_context(self, struct, opts):
        # Modify struct and/or opts
        # ...
        return struct, opts
```

#### `ContributedComponent`

Class representing a component in context.yaml:

```python
component = ContributedComponent(
    name="my_component",
    component_type="service",
    metadata={
        "language": "python",
        "endpoints": ["GET /api/v1/resource"],
    }
)
```

#### `TemplateManager`

Class for managing extension templates:

```python
template_mgr = TemplateManager("my_extension")
template = template_mgr.get_template("my_template")
rendered = template_mgr.render_pyscaffold_template(template, context)
```

#### `KhoraConfigAccessor`

Class for safely accessing Khora configuration:

```python
config = get_config_accessor(opts)
if config.is_feature_enabled("my_feature"):
    # Feature is enabled
```

### Type Aliases

- `KhoraAction`: Type alias for action functions
- `KhoraActionParams`: Type alias for action return type (Structure, ScaffoldOpts)
- `KhoraHookPoint`: Type alias for hook point tuples

### Utility Functions

- `create_extension_action()`: Factory function for creating named actions
- `get_extension_template()`: Get a template from an extension's templates directory
- `add_component_to_opts()`: Helper to add component information to opts
- `get_component_from_opts()`: Helper to get component information from opts
- `get_config_accessor()`: Factory function for creating config accessors
- `ensure_directory()`: Create a directory if it doesn't exist
- `copy_directory_structure()`: Copy a directory structure
- `safe_run_command()`: Safely run a shell command
- `snake_to_camel()`, `snake_to_pascal()`, `camel_to_snake()`: String case conversion

## Best Practices

### Project Structure

Organize your plugin project with a clear structure:

```
my_plugin/
├── __init__.py
├── extension.py       # Main extension class
├── actions.py         # Action functions
├── templates/         # Templates
│   ├── template1.template
│   └── template2.template
└── utils.py           # Utility functions
```

### Documentation

Document your plugin with comprehensive docstrings:

```python
"""
MyPlugin for Khora Kernel.

This plugin adds cool functionality to Khora projects.
It requires features.my_feature to be enabled in pyproject.toml.
"""
```

### Testing

Test your plugin thoroughly with unit and integration tests:

```python
import pytest
from pyscaffold.extensions import Extension
from my_plugin import MyPlugin

def test_extension_activation():
    # Create extension instance
    ext = MyPlugin()
    ext.opts = {"my_plugin": True}
    
    # Create a dummy actions list
    actions = []
    
    # Run activation
    result = ext.activate(actions)
    
    # Assert that actions were added
    assert len(result) > 0
```

### Configuration Schema

Define a clear configuration schema for your plugin:

```python
# In your documentation
"""
Configuration:

[tool.khora.features]
my_feature = true  # Enable my feature

[tool.khora.plugins_config.my_plugin]
option1 = "value1"
option2 = "value2"
"""
```

## Examples

### Complete Plugin Example

Here's a complete example of a simple plugin:

```python
"""
ExamplePlugin for Khora Kernel.

This plugin demonstrates key SDK features by adding custom content to the project.
"""

import logging
from pathlib import Path
from typing import Dict, List, Optional

from pyscaffold.actions import Action, ScaffoldOpts, Structure
from pyscaffold.operations import no_overwrite

from khora_kernel_vnext.sdk import (
    KhoraExtension, 
    create_extension_action,
    get_config_accessor,
    ContributedComponent,
    add_component_to_opts,
    TemplateManager
)

logger = logging.getLogger(__name__)

class ExamplePlugin(KhoraExtension):
    """
    Example plugin demonstrating Khora SDK features.
    """
    
    name = "example_plugin"
    
    def activate(self, actions: List[Action]) -> List[Action]:
        """Activate the plugin by registering actions."""
        # Only proceed if the plugin is enabled
        if not self.opts.get(self.name):
            return actions
            
        logger.info("Activating ExamplePlugin")
        
        # Register actions
        actions = self.register(
            actions, 
            add_example_files, 
            after="define_structure"
        )
        
        actions = self.register(
            actions,
            contribute_to_context,
            after="add_example_files"
        )
        
        return actions
        
    def requires(self) -> List[str]:
        """Define plugin dependencies."""
        return ["khora_core"]


def add_example_files(struct: Structure, opts: ScaffoldOpts) -> tuple[Structure, ScaffoldOpts]:
    """Add example files to the project."""
    logger.info("Adding example files")
    
    # Get config accessor
    config = get_config_accessor(opts)
    
    # Get project name
    project_name = opts.get("project_path", Path(".")).name
    
    # Create a template manager
    template_mgr = TemplateManager("example_plugin")
    
    # Try to get a template (this would need to exist in your package)
    try:
        template_content = template_mgr.get_template("example_readme")
        # Render with context
        readme_content = template_mgr.render_pyscaffold_template(
            template_content,
            {"project_name": project_name}
        )
    except Exception as e:
        logger.warning(f"Failed to load template: {e}")
        # Fallback content
        readme_content = f"# {project_name}\n\nGenerated by ExamplePlugin"
    
    # Add basic files
    example_dir = "example"
    new_files = {
        f"{example_dir}/README.md": (readme_content, no_overwrite()),
        f"{example_dir}/example.py": (
            "# Generated by ExamplePlugin\n\ndef hello():\n    print('Hello from ExamplePlugin')\n",
            no_overwrite(),
        )
    }
    
    # Add feature-specific files if enabled
    if config.is_feature_enabled("advanced_mode"):
        new_files[f"{example_dir}/advanced.py"] = (
            "# Advanced mode enabled\n\ndef advanced_feature():\n    print('Advanced feature')\n",
            no_overwrite(),
        )
    
    # Merge with existing structure
    struct.update(new_files)
    
    return struct, opts


def contribute_to_context(struct: Structure, opts: ScaffoldOpts) -> tuple[Structure, ScaffoldOpts]:
    """Contribute to context.yaml."""
    logger.info("Contributing to context.yaml")
    
    # Create a component
    component = ContributedComponent(
        name="example_component",
        component_type="example",
        metadata={
            "files": ["example/example.py", "example/README.md"],
            "description": "Example component added by ExamplePlugin"
        }
    )
    
    # Add to opts for later context.yaml generation
    add_component_to_opts(opts, "example_component", component.to_dict())
    
    return struct, opts
```

## Plugin API Reference

For detailed API reference of all SDK components, see the [SDK API Reference](./api_reference.md).

## Troubleshooting

### Common Issues

#### Plugin Not Found

If your plugin is not being discovered by Khora:

1. Ensure it's correctly registered in `pyproject.toml`
2. Verify the import path is correct
3. Check for import errors in your plugin module

#### Action Registration Fails

If your action registration fails:

1. Check if the hook point (before/after action) exists
2. Verify your action function signature
3. Look for errors in your action function

#### Template Not Found

If templates are not found:

1. Ensure they're in the correct directory (`my_plugin/templates/`)
2. Check the template name (without the `.template` extension)
3. Verify the package structure is importable

## Resources

- [PyScaffold Extension Documentation](https://pyscaffold.org/en/latest/extensions.html)
- [Example Plugins in Khora Kernel](https://github.com/your-org/khora-kernel/tree/master/examples)
- [Khora Kernel API Reference](./api_reference.md)
