# Khora Kernel vNext Development Plan (PyScaffold Adaptation)

This document outlines the development plan for Khora Kernel vNext, designed as a set of extensions for the PyScaffold framework. It prioritizes delivering a Minimum Viable Kernel (MVK - v0.1) capable of bootstrapping the 'Khora Live Transcriber' project use case effectively. The plan also maps out subsequent release milestones and integrates considerations for the four development scopes (Agentic, DevRelSecOps, Code System, Meta-Evolutionary).

## Phase 1: Define the Minimum Viable Kernel (MVK - v0.1)

This MVK focuses on providing the essential scaffolding to initiate the Khora Live Transcriber project, enabling basic development workflows.

### 1.1. MVK Core Functionality Scope

*   **Manifest Parsing:** Parse and validate a basic configuration section within `pyproject.toml` (`[tool.khora]`).
*   **Core Project Structure:** Utilize PyScaffold's default capabilities for creating the standard Python package layout (`src/khora`, `tests/`, `docs/`, `pyproject.toml`).
*   **Basic Files:** Generate a standard `.gitignore` (leveraging or augmenting PyScaffold's default).
*   **API Scaffolding (Conditional):** If specified in the manifest, generate a minimal FastAPI `main.py` (with `/healthz`), basic `requirements.txt` (FastAPI, Uvicorn), and a simple `Dockerfile` within the designated API path.
*   **Docker Compose (Minimal):** Generate a `docker-compose.yml` containing only the scaffolded API service, configured according to the manifest.
*   **CI Workflow (Minimal):** Generate a basic GitHub Actions workflow (`.github/workflows/ci.yml`) for linting, formatting checks, and running `pytest`.
*   **Pre-commit Setup (Minimal):** Configure `.pre-commit-config.yaml` using `pyscaffoldext-precommit` and ensure basic formatters/linters (Ruff, Black) are included.
*   **AI Context (Minimal):** Generate an initial `.khora/context.yaml` containing kernel/schema versions, timestamp, and basic project information derived directly from the manifest (`[tool.khora]`). Knowledge Graph features are deferred.

### 1.2. Define Required PyScaffold Extensions for MVK

*(These are conceptual Khora-specific extensions built upon PyScaffold)*

1.  **`khora-core-extension` v0.1:**
    *   **Responsibilities:**
        *   Define the schema and handle parsing/validation of the `[tool.khora]` section in `pyproject.toml`.
        *   Generate the initial `.khora/context.yaml` based on manifest data.
        *   Potentially provide shared utilities/context API for other Khora extensions.
        *   Augment PyScaffold's generated `.gitignore` if needed.
    *   **Leverages:** PyScaffold's core structure generation, `opts` and `struct` objects during actions.
2.  **`khora-fastapi-scaffold-extension` v0.1:**
    *   **Responsibilities:**
        *   Triggered by `[tool.khora.features].fastapi = true`.
        *   Generate `main.py`, `requirements.txt`, and `Dockerfile` within the directory specified by `[tool.khora.paths].api_dir`.
    *   **Leverages:** PyScaffold's file creation actions.
3.  **`khora-docker-extension` v0.1:**
    *   **Responsibilities:**
        *   Triggered by `[tool.khora.features].docker = true`.
        *   Generate `docker-compose.yml` with the API service defined (using information possibly provided by `khora-fastapi-scaffold-extension` or manifest).
    *   **Leverages:** PyScaffold's file creation actions, potentially reads metadata set by other extensions.
4.  **`khora-ci-github-actions-extension` v0.1:**
    *   **Responsibilities:**
        *   Triggered by `[tool.khora.features].ci_github_actions = true`.
        *   Generate `.github/workflows/ci.yml` with basic Lint -> Test steps.
    *   **Leverages:** PyScaffold's file creation actions.
5.  **`khora-precommit-integration` v0.1:** (Note: Might be part of `khora-core-extension` initially)
    *   **Responsibilities:**
        *   Ensure PyScaffold's built-in pre-commit support or `pyscaffoldext-precommit` is activated.
        *   Verify that standard formatters/linters (Ruff, Black) are included in the generated `.pre-commit-config.yaml`.
    *   **Leverages:** PyScaffold's pre-commit handling.

### 1.3. Define `pyproject.toml [tool.khora]` Structure for MVK

```toml
# pyproject.toml

[build-system]
requires = ["setuptools>=61.0"]
build-backend = "setuptools.build_meta"

[project]
name = "khora-live-transcriber" # Standard PyScaffold project name
version = "0.1.0"
# ... other standard project metadata generated by putup ...

# --- Khora Kernel vNext Configuration ---
[tool.khora]
# kernel_version = "0.1.0" # Optional: Tracks which kernel version was used
project_description = "Khora Live Transcriber Service"
python_version = "3.10" # Target Python version for generated configs/workflows

[tool.khora.paths]
api_dir = "src/khora_live_transcriber/api" # Relative path from project root
docs_dir = "docs"

[tool.khora.features]
# Explicitly enable MVK features
fastapi = true
docker = true
ci_github_actions = true
precommit = true # Assumes pyscaffoldext-precommit handles the basics
context = true

[tool.khora.ports]
http = 8000

[tool.khora.plugins_config.docker]
api_service_name = "api" # Name for the service in docker-compose.yml
api_image_name = "khora-live-transcriber-api" # Optional: image name

# --- Standard Tool Configuration (populated by PyScaffold & Khora extensions) ---
[tool.ruff]
# ... ruff config ...

[tool.black]
# ... black config ...

[tool.mypy]
# ... mypy config ...

[tool.pytest.ini_options]
# ... pytest config ...
```

### 1.4. Specify MVK Output Artifacts

After running `putup --khora-core --khora-fastapi-scaffold --khora-docker --khora-ci-github-actions --khora-precommit-integration <project_name>` (or similar invocation based on extension design) with the MVK manifest, the expected core artifacts include:

*   `pyproject.toml` (populated with project metadata, dependencies, `[tool.khora]`, and tool configs)
*   `.gitignore`
*   `src/khora_live_transcriber/`
    *   `__init__.py`
    *   `api/`
        *   `main.py`
        *   `requirements.txt`
        *   `Dockerfile`
*   `tests/`
*   `docs/`
*   `docker-compose.yml` (with 'api' service)
*   `.github/workflows/ci.yml` (basic lint & test)
*   `.pre-commit-config.yaml` (basic checks + formatter/linter)
*   `.khora/context.yaml` (minimal version with manifest data)

## Phase 2: Outline MVK Development Plan & Workflow

1.  **Development Environment Setup (`khora-kernel-vnext` repo):**
    *   Follow the "Green Field Setup Plan":
        *   `git init`
        *   `uv init`
        *   `mkdir -p src/khora_kernel_vnext tests docs`
        *   Create `src/khora_kernel_vnext/__init__.py`
        *   `uv pip install pyyaml jinja2 typer pyscaffold`
        *   `uv pip install --dev pytest ruff black mypy pre-commit pytest-cov`
        *   Configure tools (`ruff`, `black`, `mypy`, `pytest`) in `pyproject.toml`.
        *   Create basic `.pre-commit-config.yaml` for the kernel's *own* development (checking its own code).
        *   Create minimal `.github/workflows/kernel-ci.yml` for testing the kernel itself.
        *   Add `.khorkernel/VERSION` (or equivalent internal version file).
        *   Initial commit.
2.  **Core Development Workflow:**
    *   **TDD:** Implement Python logic within extensions using Test-Driven Development. Write unit tests *before* implementation for parsing, context generation, template data preparation, etc.
    *   **Fixture Project:** Maintain a local directory (e.g., `test_fixture_projects/live_transcriber_mvk`) containing only the minimal `pyproject.toml` defined in Phase 1.3.
    *   **Integration Testing:** Write `pytest` integration tests that:
        *   Use `subprocess` or PyScaffold's testing utilities to invoke `putup` with the development Khora extensions enabled, targeting a temporary copy of the fixture project.
        *   Assert the creation of expected files listed in Phase 1.4.
        *   Assert key content snippets within generated files (e.g., service name in `docker-compose.yml`, basic structure of `context.yaml`).
    *   **Manual Verification:** Regularly run the kernel against the fixture project manually during development to visually inspect output and catch issues not covered by automated tests.
3.  **Implementation Sequence:**
    1.  **PyScaffold Extension Structure:** Establish the basic project structure for `khora-kernel-vnext` as a package containing multiple extensions, including setting up `entry_points` in `pyproject.toml`.
    2.  **`khora-core-extension` (Manifest Parsing):** Implement parsing and validation of the `[tool.khora]` section. Define data structures to hold the parsed configuration. Write unit tests.
    3.  **`khora-core-extension` (Minimal Context Generation):** Implement the logic to generate the basic `context.yaml` from the parsed manifest. Write unit tests.
    4.  **`khora-fastapi-scaffold-extension`:** Implement template rendering for the minimal FastAPI app. Write unit/integration tests.
    5.  **`khora-docker-extension`:** Implement `Dockerfile` and minimal `docker-compose.yml` generation. Write unit/integration tests.
    6.  **`khora-ci-github-actions-extension`:** Implement basic `ci.yml` generation. Write unit/integration tests.
    7.  **`khora-precommit-integration`:** Ensure integration with PyScaffold's pre-commit setup works as expected for basic linters/formatters. Write integration tests verifying `.pre-commit-config.yaml`.
4.  **Initial "Dogfooding" Simulation:** The integration tests running against the fixture project *are* the initial dogfooding simulation. This cycle (develop extension code -> unit test -> run integration tests -> analyze output -> refine) will be the core development loop.

## Phase 3: Plan Post-MVK Releases & Evolution (Roadmap Sketch)

*   **v0.2 - Foundational Completeness & KG:**
    *   **KG Integration:** Create `khora-kg-extension` (implements `populate_kg.py` logic). Enhance `khora-core-extension` to read KG files and add summaries to `context.yaml`. Add KG scripts to `khora-precommit-integration`.
    *   **Docker Services:** Enhance `khora-docker-extension` to add database (Postgres/SQLite) and broker (Redis) services based on manifest flags. Include health checks.
    *   **Security Gates:** Add options to `khora.toml` and integrate security tools (Bandit, pip-audit, TruffleHog) into generated CI (`khora-ci-github-actions-extension`) and pre-commit (`khora-precommit-integration`).
    *   **Versioning Tool:** Implement `khora bump-version` command (potentially as part of `khora-core-extension` or a separate `khora-version-extension`) mimicking `bump_version.py`.
*   **v0.3 - Core Plugins & DX:**
    *   **Playwright/Terraform:** Develop `khora-playwright-extension` and `khora-terraform-extension` based on existing plugin logic.
    *   **Observability:** Add `observability` feature flag and corresponding Docker Compose setup in `khora-docker-extension`. Consider basic instrumentation stubs.
    *   **Context Delta:** Implement generation of the `context-delta.yml` workflow via `khora-ci-github-actions-extension`.
    *   **Diagnostics:** Implement `khora health` and `khora inspect` commands (replicating `repo_health.py`, `repo_inspect.py`) within the kernel CLI or core extension.
*   **v0.4+ - Advanced Features & Ecosystem:**
    *   Refine Plugin SDK based on feedback.
    *   Explore advanced KG features (relationships, validation).
    *   Investigate alternative manifest formats or layering.
    *   Develop documentation generation plugins.
    *   Enhance AI context features (e.g., more detailed component descriptions).

*   **Managing Evolution:**
    *   **SDK Versioning:** Use Semantic Versioning for the internal Plugin API provided by `khora-core-extension`. Changes requiring updates to other Khora extensions constitute a minor/major bump.
    *   **Feedback Loop:** Use GitHub issues in the kernel repo. Regularly use the kernel builds for the Khora Live Transcriber project (once MVK is usable) and file detailed feedback.
    *   **Breaking Changes:** Announce clearly in `CHANGELOG.md` and release notes. Use deprecation warnings where possible before removal. Provide migration steps.

## Phase 4: Mapping the Plan to the Four Scopes

*   **Agentic System:**
    *   **MVK:** Provides the initial `context.yaml` structure and manifest-derived data. Establishes the foundation for AI interaction.
    *   **v0.2:** Significantly enhances context with KG summaries, making the AI more aware of the project's domain.
    *   **v0.3+:** Context Delta workflow explicitly supports AI awareness of changes. Enhanced context features further improve AI understanding.
*   **DevRelSecOps System:**
    *   **MVK:** Establishes the minimum viable loop: code -> pre-commit -> basic CI -> Docker environment.
    *   **v0.2:** Adds crucial layers: security scanning, database/broker orchestration, version management tooling.
    *   **v0.3+:** Integrates more specialized tooling (UI testing, IaC) and observability infrastructure.
*   **Code System (Target Project - e.g., Khora Live Transcriber):**
    *   **MVK:** Creates the initial FastAPI application skeleton and its immediate environment, allowing development to start.
    *   **v0.2:** Enables integration with database/broker dependencies required by the Transcriber architecture.
    *   **v0.3+:** Supports adding necessary testing (Playwright) and infrastructure (Terraform) code as the Transcriber project grows.
*   **Meta-Evolutionary System:**
    *   **MVK Plan:** The iterative development plan, TDD focus, integration testing against fixtures, and greenfield setup establish the *process* for evolving the kernel.
    *   **v0.2:** Introduces version bumping tooling *for the kernel*.
    *   **Post-MVK:** Explicitly defines strategies for SDK versioning, feedback incorporation, and managing breaking changes, ensuring the kernel itself can evolve sustainably. The modular plugin architecture (Candidate 1) is key to this.

This plan provides an actionable roadmap for building Khora Kernel vNext as a robust, extensible, and AI-focused scaffolding tool based on the PyScaffold framework.